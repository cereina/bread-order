<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bread Order App</title>
<link rel="stylesheet" href="styles.css">
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
header { display: flex; justify-content: space-between; align-items: center; }
#orders, #items { margin-top: 20px; }
table { border-collapse: collapse; width: 100%; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 8px; text-align: left; }
button { margin: 2px; }
</style>
</head>
<body>

<header>
  <h1>Bread Order App</h1>
  <div>
    Logged in as: <span id="username"></span> (<span id="role"></span>)
    <button id="logoutBtn">Logout</button>
  </div>
</header>

<section id="orderSection">
  <h2>Place an Order</h2>
  <select id="itemSelect"></select>
  <input type="number" id="qtyInput" placeholder="Quantity" min="1" value="1">
  <button id="addOrderBtn">Add Order</button>
</section>

<section id="orders">
  <h2>Orders</h2>
  <table>
    <thead><tr><th>Item</th><th>Quantity</th><th>Actions</th></tr></thead>
    <tbody id="ordersBody"></tbody>
  </table>
</section>

<section id="items" style="display:none;">
  <h2>Manage Items (Admin)</h2>
  <input type="text" id="newItemName" placeholder="New item name">
  <button id="addItemBtn">Add Item</button>
  <ul id="itemsList"></ul>
</section>

<section id="users" style="display:none;">
  <h2>Manage Users (Admin)</h2>
  <input type="text" id="newUsername" placeholder="Username">
  <input type="password" id="newPassword" placeholder="Password">
  <select id="newRole">
    <option value="user">User</option>
    <option value="admin">Admin</option>
  </select>
  <button id="addUserBtn">Add User</button>
  <table>
    <thead><tr><th>Username</th><th>Role</th><th>Actions</th></tr></thead>
    <tbody id="usersBody"></tbody>
  </table>
</section>

<script>
async function fetchJSON(url, opts) {
  const res = await fetch(url, opts);
  if (!res.ok) throw new Error((await res.json()).error || res.statusText);
  return res.json();
}

async function init() {
  try {
    const me = await fetchJSON('/api/me');
    if (!me.user) return location.href = '/login.html';
    document.getElementById('username').textContent = me.user.username;
    document.getElementById('role').textContent = me.user.role;
    if (me.user.role === 'admin') {
      document.getElementById('items').style.display = '';
      document.getElementById('users').style.display = '';
      loadItemsAdmin();
      loadUsers();
    }
    loadItems();
    loadOrders();
  } catch {
    location.href = '/login.html';
  }
}

document.getElementById('logoutBtn').onclick = async () => {
  await fetch('/api/logout', { method: 'POST' });
  location.href = '/login.html';
};

async function loadItems() {
  const items = await fetchJSON('/api/items');
  const sel = document.getElementById('itemSelect');
  sel.innerHTML = '';
  items.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });
}

async function loadOrders() {
  const orders = await fetchJSON('/api/orders');
  const tbody = document.getElementById('ordersBody');
  tbody.innerHTML = '';
  orders.forEach((o, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.item}</td><td>${o.qty}</td>
      <td>
        <button onclick="deleteOrder(${idx})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

async function deleteOrder(idx) {
  await fetch(`/api/orders/${idx}`, { method: 'DELETE' });
  loadOrders();
}

document.getElementById('addOrderBtn').onclick = async () => {
  const item = document.getElementById('itemSelect').value;
  const qty = parseInt(document.getElementById('qtyInput').value, 10);
  await fetchJSON('/api/orders', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ item, qty })
  });
  loadOrders();
};

// ===== Admin: Items =====
async function loadItemsAdmin() {
  const items = await fetchJSON('/api/items');
  const list = document.getElementById('itemsList');
  list.innerHTML = '';
  items.forEach((name, idx) => {
    const li = document.createElement('li');
    li.innerHTML = `${name}
      <button onclick="editItem(${idx}, '${name}')">Edit</button>
      <button onclick="deleteItem(${idx})">Delete</button>`;
    list.appendChild(li);
  });
}
document.getElementById('addItemBtn').onclick = async () => {
  const name = document.getElementById('newItemName').value;
  await fetchJSON('/api/items', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name })
  });
  document.getElementById('newItemName').value = '';
  loadItems();
  loadItemsAdmin();
};
async function editItem(idx, oldName) {
  const newName = prompt('New name:', oldName);
  if (!newName) return;
  await fetchJSON(`/api/items/${idx}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: newName })
  });
  loadItems();
  loadItemsAdmin();
}
async function deleteItem(idx) {
  // Not implemented in server.js, could be added
  alert('Delete item not implemented');
}

// ===== Admin: Users =====
async function loadUsers() {
  const users = await fetchJSON('/api/users');
  const tbody = document.getElementById('usersBody');
  tbody.innerHTML = '';
  users.forEach(u => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.username}</td><td>${u.role}</td>
      <td>
        <button onclick="editUser('${u.username}', '${u.role}')">Edit</button>
        <button onclick="deleteUser('${u.username}')">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById('addUserBtn').onclick = async () => {
  const username = document.getElementById('newUsername').value;
  const password = document.getElementById('newPassword').value;
  const role = document.getElementById('newRole').value;
  await fetchJSON('/api/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password, role })
  });
  document.getElementById('newUsername').value = '';
  document.getElementById('newPassword').value = '';
  loadUsers();
};
async function editUser(username, role) {
  const newPassword = prompt('Enter new password (leave blank to keep same):');
  const newRole = prompt('Enter new role (user/admin):', role);
  await fetchJSON(`/api/users/${encodeURIComponent(username)}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: newPassword || undefined, role: newRole || undefined })
  });
  loadUsers();
}
async function deleteUser(username) {
  await fetchJSON(`/api/users/${encodeURIComponent(username)}`, { method: 'DELETE' });
  loadUsers();
}

init();
</script>

</body>
</html>
